{% extends "base_stable.html" %}

{% block title %}R√©sultats - Component Data Processor Stable{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-download me-2"></i>Fichiers de R√©sultats
                </h4>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <p class="text-muted mb-1">
                            T√©l√©chargez les fichiers de r√©sultats g√©n√©r√©s par le traitement
                        </p>
                        <small class="text-muted">
                            <i class="fas fa-eye me-1"></i>Utilisez "Aper√ßu" pour voir le contenu sans t√©l√©charger
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success btn-sm" onclick="downloadAll()" id="download-all-btn" style="display: none;">
                            <i class="fas fa-download me-1"></i>Tout T√©l√©charger
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshResults()">
                            <i class="fas fa-sync-alt me-1"></i>Actualiser
                        </button>
                    </div>
                </div>
                
                <!-- Zone de chargement -->
                <div id="loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-2 text-muted">Chargement des fichiers...</p>
                </div>
                
                <!-- Liste des fichiers -->
                <div id="files-container" class="d-none">
                    <div id="files-list"></div>
                </div>
                
                <!-- Message si aucun fichier -->
                <div id="no-files" class="text-center py-4 d-none">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <h5>Aucun fichier de r√©sultat disponible</h5>
                    <p class="text-muted">
                        Traitez d'abord un fichier pour voir les r√©sultats ici.
                    </p>
                    <a href="{{ url_for('upload_enhanced') }}" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Traiter un fichier
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Informations sur les types de fichiers -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Types de Fichiers G√©n√©r√©s</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center p-3 border rounded" style="border-color: #28a745 !important; background-color: #f8fff8;">
                            <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                            <h5 class="text-success">üìä Fichier Principal</h5>
                            <h6><strong>Update_YYYY-MM-DD.xlsx</strong></h6>
                            <small class="text-muted">
                                <strong>VOS DONN√âES avec informations Master BOM</strong><br>
                                Contient vos donn√©es d'origine enrichies avec Status, Description, Price selon le projet s√©lectionn√©
                            </small>
                            <div class="mt-2">
                                <span class="badge bg-success">FICHIER PRINCIPAL √Ä T√âL√âCHARGER</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-database fa-2x text-secondary mb-2"></i>
                            <h6>Master BOM Mis √† Jour</h6>
                            <small class="text-muted">
                                Master BOM complet avec nouvelles donn√©es int√©gr√©es (fichier de r√©f√©rence)
                            </small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                            <h6>R√©sum√© de Traitement</h6>
                            <small class="text-muted">
                                Statistiques d√©taill√©es du traitement effectu√© (CSV)
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let filesData = [];
    
    async function loadResults() {
        try {
            document.getElementById('loading').classList.remove('d-none');
            document.getElementById('files-container').classList.add('d-none');
            document.getElementById('no-files').classList.add('d-none');
            
            const response = await fetch('/api/list-outputs');
            const data = await response.json();
            
            document.getElementById('loading').classList.add('d-none');
            
            if (data.success && data.files && data.files.length > 0) {
                filesData = data.files;
                displayFiles(data.files);
                document.getElementById('files-container').classList.remove('d-none');
            } else {
                document.getElementById('no-files').classList.remove('d-none');
            }
            
        } catch (error) {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('no-files').classList.remove('d-none');
            showError('Erreur lors du chargement des fichiers: ' + error.message);
        }
    }
    
    function displayFiles(files) {
        const container = document.getElementById('files-list');

        if (files.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">Aucun fichier disponible</p>';
            document.getElementById('download-all-btn').style.display = 'none';
            return;
        }

        // Organiser les fichiers par cat√©gories
        const mainFiles = [];
        const masterBomFiles = [];
        const summaryFiles = [];
        const otherFiles = [];

        files.forEach(file => {
            const name = file.filename.toLowerCase();
            if (name.startsWith('update_') && name.endsWith('.xlsx')) {
                mainFiles.push(file);
            } else if (name.includes('master_bom')) {
                masterBomFiles.push(file);
            } else if (name.includes('summary') || name.includes('processing')) {
                summaryFiles.push(file);
            } else {
                otherFiles.push(file);
            }
        });

        let html = '';

        // Section Fichiers Principaux
        if (mainFiles.length > 0) {
            html += `
                <div class="mb-4">
                    <h6 class="text-success mb-3">
                        <i class="fas fa-star me-2"></i>Fichiers Principaux (Vos donn√©es enrichies)
                    </h6>
                    <div class="list-group">
            `;

            mainFiles.forEach(file => {
                html += createFileItem(file, true);
            });

            html += '</div></div>';
        }

        // Section Fichiers de R√©f√©rence
        if (masterBomFiles.length > 0) {
            html += `
                <div class="mb-4">
                    <h6 class="text-secondary mb-3">
                        <i class="fas fa-database me-2"></i>Fichiers de R√©f√©rence (Master BOM)
                    </h6>
                    <div class="list-group">
            `;

            masterBomFiles.forEach(file => {
                html += createFileItem(file, false);
            });

            html += '</div></div>';
        }

        // Section Rapports
        if (summaryFiles.length > 0) {
            html += `
                <div class="mb-4">
                    <h6 class="text-info mb-3">
                        <i class="fas fa-chart-line me-2"></i>Rapports de Traitement
                    </h6>
                    <div class="list-group">
            `;

            summaryFiles.forEach(file => {
                html += createFileItem(file, false);
            });

            html += '</div></div>';
        }

        // Section Autres Fichiers
        if (otherFiles.length > 0) {
            html += `
                <div class="mb-4">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-folder me-2"></i>Autres Fichiers
                    </h6>
                    <div class="list-group">
            `;

            otherFiles.forEach(file => {
                html += createFileItem(file, false);
            });

            html += '</div></div>';
        }

        container.innerHTML = html;

        // Afficher le bouton "Tout t√©l√©charger" s'il y a plusieurs fichiers
        if (files.length > 1) {
            document.getElementById('download-all-btn').style.display = 'inline-block';
        }
    }

    function createFileItem(file, isMainFile) {
        const fileSize = formatFileSize(file.size);
        const fileDate = new Date(file.modified * 1000).toLocaleString('fr-FR');
        const fileIcon = getFileIcon(file.filename);
        const description = getFileDescription(file.filename);

        const itemClass = isMainFile ? 'list-group-item border-success bg-light' : 'list-group-item';
        const badge = isMainFile ? '<span class="badge bg-success ms-2">FICHIER PRINCIPAL</span>' : '';

        return `
            <div class="${itemClass}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="d-flex align-items-center">
                        <i class="${fileIcon} fa-2x me-3"></i>
                        <div>
                            <h6 class="mb-1">${file.filename}${badge}</h6>
                            <p class="mb-1 text-muted small">${description}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>${fileDate} ‚Ä¢
                                <i class="fas fa-hdd me-1"></i>${fileSize}
                            </small>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-info btn-sm" onclick="previewFile('${file.filename}')" title="Voir le contenu sans t√©l√©charger">
                            <i class="fas fa-eye me-1"></i>Aper√ßu
                        </button>
                        <a href="${file.frontend_download_url}" class="btn ${isMainFile ? 'btn-success' : 'btn-outline-success'} btn-sm" title="T√©l√©charger le fichier">
                            <i class="fas fa-download me-1"></i>${isMainFile ? 'T√©l√©charger Principal' : 'T√©l√©charger'}
                        </a>
                    </div>
                </div>
            </div>
        `;
    }
    
    function getFileIcon(filename) {
        const name = filename.toLowerCase();
        if (name.startsWith('update_') && name.endsWith('.xlsx')) {
            return 'fas fa-star text-warning'; // Fichier principal - √©toile dor√©e
        } else if (name.includes('master_bom')) {
            return 'fas fa-database text-secondary';
        } else if (name.includes('summary') || name.includes('processing')) {
            return 'fas fa-chart-line text-info';
        } else if (name.includes('excluded') || name.includes('clean')) {
            return 'fas fa-file-alt text-warning';
        } else {
            return 'fas fa-file text-secondary';
        }
    }

    function getFileDescription(filename) {
        const name = filename.toLowerCase();
        if (name.startsWith('update_') && name.endsWith('.xlsx')) {
            return 'üìä VOS DONN√âES enrichies avec informations Master BOM (Status, Description, Price) selon le projet s√©lectionn√©';
        } else if (name.includes('master_bom')) {
            return 'üóÑÔ∏è Master BOM complet mis √† jour avec nouvelles donn√©es (fichier de r√©f√©rence)';
        } else if (name.includes('summary') || name.includes('processing')) {
            return 'üìà Statistiques d√©taill√©es du traitement (nombre de lignes, dur√©e, etc.)';
        } else if (name.includes('excluded') || name.includes('clean')) {
            return '‚ö†Ô∏è Donn√©es qui n\'ont pas pu √™tre trait√©es (lignes exclues)';
        } else {
            return 'üìÑ Fichier de r√©sultat du traitement';
        }
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    async function previewFile(filename) {
        try {
            // Afficher un modal de chargement
            const previewModal = document.createElement('div');
            previewModal.className = 'modal fade';
            previewModal.id = 'preview-modal';
            previewModal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-eye me-2"></i>Aper√ßu : ${filename}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="preview-content">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                                <p class="mt-2">Chargement de l'aper√ßu...</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a href="/download/${filename}" class="btn btn-success">
                                <i class="fas fa-download me-1"></i>T√©l√©charger ce fichier
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(previewModal);
            const modal = new bootstrap.Modal(previewModal);
            modal.show();

            // Charger l'aper√ßu
            const response = await fetch(`/api/preview/${filename}`);
            const data = await response.json();

            if (data.success && data.preview) {
                const preview = data.preview;
                let html = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle me-2"></i>Informations du fichier</h6>
                            <ul class="list-unstyled">
                                <li><strong>Nom :</strong> ${preview.filename}</li>
                                <li><strong>Lignes :</strong> ${preview.total_rows}</li>
                                <li><strong>Colonnes :</strong> ${preview.total_columns}</li>
                                <li><strong>Taille :</strong> ${formatFileSize(preview.file_size)}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-columns me-2"></i>Colonnes disponibles</h6>
                            <div class="d-flex flex-wrap gap-1">
                `;

                preview.columns.forEach(col => {
                    const isImportant = ['PN', 'YAZAKI PN', 'Status', 'Description', 'Price', 'Project'].some(important =>
                        col.toLowerCase().includes(important.toLowerCase())
                    );
                    html += `<span class="badge ${isImportant ? 'bg-primary' : 'bg-secondary'}">${col}</span>`;
                });

                html += `
                            </div>
                        </div>
                    </div>

                    <h6><i class="fas fa-table me-2"></i>Aper√ßu des donn√©es (5 premi√®res lignes)</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead class="table-dark">
                                <tr>
                `;

                preview.columns.forEach(col => {
                    html += `<th>${col}</th>`;
                });

                html += `
                                </tr>
                            </thead>
                            <tbody>
                `;

                preview.sample_data.forEach(row => {
                    html += '<tr>';
                    preview.columns.forEach(col => {
                        const value = row[col] || '';
                        const displayValue = String(value).length > 30 ? String(value).substring(0, 30) + '...' : value;
                        html += `<td title="${value}">${displayValue}</td>`;
                    });
                    html += '</tr>';
                });

                html += `
                            </tbody>
                        </table>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note :</strong> Cet aper√ßu montre seulement les 5 premi√®res lignes.
                        Le fichier complet contient ${preview.total_rows} lignes.
                    </div>
                `;

                document.getElementById('preview-content').innerHTML = html;

            } else {
                document.getElementById('preview-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Impossible de charger l'aper√ßu : ${data.message || 'Erreur inconnue'}
                    </div>
                `;
            }

            // Nettoyer le modal quand il se ferme
            previewModal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(previewModal);
            });

        } catch (error) {
            console.error('Erreur aper√ßu:', error);
            alert(`Erreur lors du chargement de l'aper√ßu: ${error.message}`);
        }
    }
    
    function refreshResults() {
        loadResults();
    }
    
    // Charger les r√©sultats au d√©marrage
    document.addEventListener('DOMContentLoaded', function() {
        loadResults();
        
        // Actualiser automatiquement toutes les 30 secondes
        setInterval(loadResults, 30000);
    });
    
    // Fonction pour t√©l√©charger tous les fichiers
    function downloadAll() {
        if (filesData.length === 0) {
            showError('Aucun fichier √† t√©l√©charger');
            return;
        }

        // Demander confirmation
        const mainFiles = filesData.filter(f => f.filename.toLowerCase().startsWith('update_'));
        const otherFiles = filesData.filter(f => !f.filename.toLowerCase().startsWith('update_'));

        let message = `T√©l√©charger ${filesData.length} fichier(s) ?\n\n`;
        if (mainFiles.length > 0) {
            message += `üìä Fichiers principaux : ${mainFiles.length}\n`;
        }
        if (otherFiles.length > 0) {
            message += `üìÅ Autres fichiers : ${otherFiles.length}\n`;
        }
        message += '\nLes t√©l√©chargements se feront avec un d√©lai de 1 seconde entre chaque fichier.';

        if (!confirm(message)) {
            return;
        }

        // D√©sactiver le bouton pendant le t√©l√©chargement
        const downloadBtn = document.getElementById('download-all-btn');
        const originalText = downloadBtn.innerHTML;
        downloadBtn.disabled = true;

        let downloaded = 0;

        filesData.forEach((file, index) => {
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = file.frontend_download_url;
                link.download = file.filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                downloaded++;
                downloadBtn.innerHTML = `<i class="fas fa-download me-1"></i>T√©l√©chargement... ${downloaded}/${filesData.length}`;

                // R√©activer le bouton quand tous les t√©l√©chargements sont lanc√©s
                if (downloaded === filesData.length) {
                    setTimeout(() => {
                        downloadBtn.disabled = false;
                        downloadBtn.innerHTML = originalText;
                        showSuccess(`${filesData.length} fichier(s) t√©l√©charg√©(s)`);
                    }, 1000);
                }

            }, index * 1000); // D√©lai de 1 seconde entre chaque t√©l√©chargement
        });
    }
</script>
{% endblock %}
